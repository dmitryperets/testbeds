# Large Scale Deployment 

This project goal is to have 2000/3000 VMs to test Fortinet management (FMG, FAZ, PORTAL) at large scale for MSSP usage.

Assumptions:
 hosts called massive<N> where N is 1 to 4

Limitations:
 1000 VMs per server (limit on the libvirt bridge)

See HyperVisorsSetup.md to set the hypervisor.

```shell
git clone https://github.com/fortinet-solutions-cse/testbeds.git -b LargeScaleDeployment
```

Now, in FlexVM portal create a 'Configuration'  (e.g.: 4 cpu and 360 program) and add all required licenses to it, according to your setup: e.g. 3000 licenses for 3 hosts. Ensure each license corresponds to a single site, and enforce this fact by placing the site id in the license description as follows:

```site-N-M```, where N and M correspond to the numbering of each site.

Don't do this operation manually if you have a massive amount of VMs. Keep on reading to see how to automate.

Use the functions in ```flex_vm_license.py``` to create the licenses automatically. The code can calculate the correct site id (N and M) properly: it can iterate over all 'site-N-M' licenses, with M=1-250 and N=1-16 or more (Note iteration is not lineal for N, as it goes first over the sites in the first node, that is, N=1, 5 ,9, 13 then 2, 6, 10, 14, and then 3, 7, 11, 15).

If you already have the licenses created, you can always update them (this is mostly to update the description or site-id) with a function already prepared (check example in code). The above mentioned python file contains functions and documented examples to get started, but some python knowledge is required.

As a reference, you should see something like this in FlexVM portal (special attention to the Description field, which is the key point to make the scripts work)

```
Serial Number     License File Token    Configuration        Description  Termination Date     Status
FGVMMLTM01002580  55CA1A6EFCA64DF7B07D  FGTVM - 4 cpu - 360  site-1-1     2022-05-06T00:00:00  ACTIVE
FGVMMLTM01002581  4004761DB2ADE137C352  FGTVM - 4 cpu - 360  site-1-2     2022-05-06T00:00:00  ACTIVE
FGVMMLTM01002582  A688FCDABEC4911072A0  FGTVM - 4 cpu - 360  site-1-3     2022-05-06T00:00:00  ACTIVE
```

Summarizing, each license should have a VM serial number (automatically generated by FortiCare), a configuration id (indicating a number of cpus and program), a description (e.g. site-9-4) and a license termination date.


# sites
Naming schema and access:
every VM is called branch-N-M where M<250

We have 4 hypervisors 10.210.15.[1-4] the VM is on machine N modulo 4, for example N=6 is on massive2 (10.210.15.2)

To access:
log on host: ssh fortinet@10.210.15.1 (passwd fortinet)

To ssh to console:
ssh admin@192.168.N.M
Or go to console:
virsh console branch-N-M

Network setup:
port2: 172.18.N.M/24

port3: 172.19.N.M/24

port4: 10.N.M.1/24
port5: 10.(100+N).M.1/24

Running a client on port4:
docker run --net=cn-m --ip=10.n.m.22 -it alpine /bin/sh

.22 is arbitrary you have /24 and will be the client ip
Running a client on port5:
docker run --net=c(100+n)-m --ip=10.(100+n).m.22 -it alpine /bin/sh

Create 1 to verify:
cd testbeds/fortigate/LargeScaleDeployment/

# FMG
```shell
virt-install --name FMG6.4.4  --os-variant generic --ram 16000 --disk path=~/images/fmg.qcow2,bus=virtio --vcpus=4 --os-type=linux --cpu=host --import --noautoconsole --keymap=en-us --network network:mtap-eno2,model=virtio \
 --network network:mtap-eno3,model=virtio --disk path=/var/lib/libvirt/images/fmgdata1.qcow2,size=100,bus=virtio
```

Find non running VM: 
for m in {1..250}; do virsh domid site-5-$m >/dev/null  ; done
for m in {1..250}; do virsh domid site-5-$m >/dev/null || ./restart ; done